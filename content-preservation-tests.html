<!DOCTYPE html>
<html>
<head>
    <title>PDF Content Preservation Tests</title>
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .test-fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .test-running { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .canvas-container { margin: 10px 0; }
        .canvas-container canvas { border: 1px solid #ccc; max-width: 100%; }
        .text-analysis { font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: scroll; background: #f8f9fa; padding: 10px; }
    </style>
</head>
<body>
    <h1>PDF Content Preservation Tests</h1>
    <p>These tests verify that PDF content is actually preserved during conversion.</p>
    
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div id="test-results"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="working-pdf-extractor.js"></script>
    <script src="converter.js"></script>
    
    <script>
        class ContentPreservationTests {
            constructor() {
                this.results = [];
                this.converter = new FileConverter();
            }
            
            log(message) {
                console.log(message);
                document.getElementById('test-results').innerHTML += `<div>${message}</div>`;
            }
            
            addResult(testName, passed, message, details = '') {
                const result = {
                    test: testName,
                    passed: passed,
                    message: message,
                    details: details,
                    timestamp: new Date().toISOString()
                };
                
                this.results.push(result);
                
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                resultDiv.innerHTML = `
                    <strong>${passed ? '‚úÖ PASS' : '‚ùå FAIL'}: ${testName}</strong><br>
                    ${message}
                    ${details ? `<div class="text-analysis">${details}</div>` : ''}
                `;
                
                document.getElementById('test-results').appendChild(resultDiv);
            }
            
            async runAllTests() {
                this.results = [];
                document.getElementById('test-results').innerHTML = '';
                
                this.log('<h2>üß™ Starting PDF Content Preservation Tests</h2>');
                
                try {
                    // Test 1: Create and convert a PDF with known text
                    await this.testKnownTextPreservation();
                    
                    // Test 2: Test with various PDF features
                    await this.testComplexPDFFeatures();
                    
                    // Test 3: Pixel-level content analysis
                    await this.testPixelLevelAnalysis();
                    
                    // Test 4: Text extraction comparison
                    await this.testTextExtractionComparison();
                    
                    this.showFinalResults();
                    
                } catch (error) {
                    this.addResult('Test Framework', false, `Test framework error: ${error.message}`);
                }
            }
            
            async testKnownTextPreservation() {
                this.log('<h3>üî¨ Test 1: Known Text Preservation</h3>');
                
                try {
                    // Create a PDF with known text content
                    const testText = [
                        'CONTENT PRESERVATION TEST',
                        'This is line 1 of test content.',
                        'This is line 2 with different text.',
                        'Line 3: Special characters √†√°√¢√£√§√•',
                        'Line 4: Numbers 1234567890',
                        'Line 5: Symbols !@#$%^&*()',
                        'END OF TEST CONTENT'
                    ];
                    
                    const testPDF = await this.createTestPDF(testText);
                    
                    // Convert PDF to image
                    const result = await this.converter.convertPDFToImage(
                        testPDF, 'png', 'test_known_text',
                        (progress) => this.log(`Progress: ${progress}%`)
                    );
                    
                    // Analyze the converted image for text content
                    const analysis = await this.analyzeImageForText(result.blob, testText);
                    
                    if (analysis.hasExpectedContent) {
                        this.addResult(
                            'Known Text Preservation', 
                            true, 
                            `Successfully preserved ${analysis.foundTexts.length}/${testText.length} text elements`,
                            `Found texts: ${analysis.foundTexts.join(', ')}`
                        );
                    } else {
                        this.addResult(
                            'Known Text Preservation', 
                            false, 
                            `Failed to preserve text content. Expected texts not found in converted image.`,
                            `Expected: ${testText.join(', ')}<br>Analysis: ${analysis.details}`
                        );
                    }
                    
                } catch (error) {
                    this.addResult('Known Text Preservation', false, `Test failed with error: ${error.message}`);
                }
            }
            
            async testComplexPDFFeatures() {
                this.log('<h3>üî¨ Test 2: Complex PDF Features</h3>');
                
                try {
                    const complexPDF = await this.createComplexTestPDF();
                    
                    const result = await this.converter.convertPDFToImage(
                        complexPDF, 'png', 'test_complex',
                        (progress) => this.log(`Complex PDF Progress: ${progress}%`)
                    );
                    
                    const analysis = await this.analyzeComplexContent(result.blob);
                    
                    const passThreshold = 0.1; // At least 10% non-white pixels indicates content
                    
                    if (analysis.contentRatio > passThreshold) {
                        this.addResult(
                            'Complex PDF Features', 
                            true, 
                            `Complex PDF converted with ${(analysis.contentRatio * 100).toFixed(2)}% content coverage`,
                            `Pixel analysis: ${analysis.details}`
                        );
                    } else {
                        this.addResult(
                            'Complex PDF Features', 
                            false, 
                            `Complex PDF conversion failed - only ${(analysis.contentRatio * 100).toFixed(2)}% content`,
                            `Insufficient content detected. ${analysis.details}`
                        );
                    }
                    
                } catch (error) {
                    this.addResult('Complex PDF Features', false, `Test failed: ${error.message}`);
                }
            }
            
            async testPixelLevelAnalysis() {
                this.log('<h3>üî¨ Test 3: Pixel-Level Content Analysis</h3>');
                
                try {
                    // Create a simple black text on white background PDF
                    const simplePDF = await this.createSimpleTextPDF();
                    
                    const result = await this.converter.convertPDFToImage(
                        simplePDF, 'png', 'test_pixels',
                        (progress) => this.log(`Pixel test progress: ${progress}%`)
                    );
                    
                    const pixelAnalysis = await this.performDetailedPixelAnalysis(result.blob);
                    
                    // We expect to find black pixels (text) and white pixels (background)
                    const hasBlackPixels = pixelAnalysis.blackPixelCount > 100; // At least 100 black pixels
                    const hasWhitePixels = pixelAnalysis.whitePixelCount > 1000; // Plenty of white background
                    const hasContent = hasBlackPixels && hasWhitePixels;
                    
                    if (hasContent) {
                        this.addResult(
                            'Pixel-Level Analysis', 
                            true, 
                            `Detected proper text rendering: ${pixelAnalysis.blackPixelCount} black pixels, ${pixelAnalysis.whitePixelCount} white pixels`,
                            `Analysis: ${JSON.stringify(pixelAnalysis, null, 2)}`
                        );
                    } else {
                        this.addResult(
                            'Pixel-Level Analysis', 
                            false, 
                            `No proper text content detected in pixels`,
                            `Black pixels: ${pixelAnalysis.blackPixelCount}, White pixels: ${pixelAnalysis.whitePixelCount}<br>Details: ${JSON.stringify(pixelAnalysis, null, 2)}`
                        );
                    }
                    
                } catch (error) {
                    this.addResult('Pixel-Level Analysis', false, `Test failed: ${error.message}`);
                }
            }
            
            async testTextExtractionComparison() {
                this.log('<h3>üî¨ Test 4: Text Extraction Comparison</h3>');
                
                try {
                    const originalText = 'HELLO WORLD TEST DOCUMENT';
                    const testPDF = await this.createSimpleTextPDF(originalText);
                    
                    // Extract text directly from PDF
                    const pdfText = await this.extractTextFromPDF(testPDF);
                    
                    // Convert PDF to image
                    const result = await this.converter.convertPDFToImage(
                        testPDF, 'png', 'test_text_extraction',
                        (progress) => this.log(`Text extraction progress: ${progress}%`)
                    );
                    
                    // Try to detect if the original text appears in the converted image
                    const textPreserved = await this.checkTextPreservation(result.blob, originalText);
                    
                    if (textPreserved) {
                        this.addResult(
                            'Text Extraction Comparison', 
                            true, 
                            `Original text "${originalText}" appears to be preserved in converted image`,
                            `PDF extracted text: "${pdfText}"`
                        );
                    } else {
                        this.addResult(
                            'Text Extraction Comparison', 
                            false, 
                            `Original text "${originalText}" was NOT preserved in converted image`,
                            `PDF extracted text: "${pdfText}" - Image analysis failed to detect text content`
                        );
                    }
                    
                } catch (error) {
                    this.addResult('Text Extraction Comparison', false, `Test failed: ${error.message}`);
                }
            }
            
            async createTestPDF(textLines) {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                pdf.setFontSize(14);
                
                let y = 30;
                textLines.forEach(line => {
                    pdf.text(line, 20, y);
                    y += 20;
                });
                
                const pdfBlob = pdf.output('blob');
                return new File([pdfBlob], 'test.pdf', { type: 'application/pdf' });
            }
            
            async createComplexTestPDF() {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                // Add title
                pdf.setFontSize(20);
                pdf.text('COMPLEX PDF TEST', 20, 30);
                
                // Add various text sizes
                pdf.setFontSize(16);
                pdf.text('Large Text Section', 20, 60);
                
                pdf.setFontSize(12);
                pdf.text('Regular text with standard size', 20, 80);
                
                pdf.setFontSize(8);
                pdf.text('Small text that should still be readable', 20, 100);
                
                // Add shapes
                pdf.rect(20, 120, 50, 30);
                pdf.circle(100, 135, 15);
                
                // Add more text
                pdf.setFontSize(12);
                pdf.text('Text after shapes', 20, 170);
                
                const pdfBlob = pdf.output('blob');
                return new File([pdfBlob], 'complex.pdf', { type: 'application/pdf' });
            }
            
            async createSimpleTextPDF(text = 'SIMPLE TEST TEXT') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                pdf.setFontSize(24);
                pdf.text(text, 50, 100);
                
                const pdfBlob = pdf.output('blob');
                return new File([pdfBlob], 'simple.pdf', { type: 'application/pdf' });
            }
            
            async analyzeImageForText(imageBlob, expectedTexts) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        // Add canvas to page for visual inspection
                        this.addCanvasToResults('Known Text Test Result', canvas);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        // Simple heuristic: if we have enough non-white pixels, assume text is there
                        let nonWhitePixels = 0;
                        const data = imageData.data;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            
                            if (r < 240 || g < 240 || b < 240) {
                                nonWhitePixels++;
                            }
                        }
                        
                        const contentRatio = nonWhitePixels / (canvas.width * canvas.height);
                        const hasContent = contentRatio > 0.01; // At least 1% content
                        
                        resolve({
                            hasExpectedContent: hasContent,
                            foundTexts: hasContent ? ['Content detected via pixel analysis'] : [],
                            details: `Image: ${canvas.width}x${canvas.height}, Non-white pixels: ${nonWhitePixels}, Content ratio: ${(contentRatio * 100).toFixed(2)}%`
                        });
                    };
                    img.src = URL.createObjectURL(imageBlob);
                });
            }
            
            async analyzeComplexContent(imageBlob) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        this.addCanvasToResults('Complex PDF Test Result', canvas);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        let contentPixels = 0;
                        const data = imageData.data;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            
                            if (r < 250 || g < 250 || b < 250) {
                                contentPixels++;
                            }
                        }
                        
                        const totalPixels = canvas.width * canvas.height;
                        const contentRatio = contentPixels / totalPixels;
                        
                        resolve({
                            contentRatio: contentRatio,
                            details: `${contentPixels}/${totalPixels} pixels have content`
                        });
                    };
                    img.src = URL.createObjectURL(imageBlob);
                });
            }
            
            async performDetailedPixelAnalysis(imageBlob) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        this.addCanvasToResults('Pixel Analysis Result', canvas);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        let blackPixelCount = 0;
                        let whitePixelCount = 0;
                        let grayPixelCount = 0;
                        let colorPixelCount = 0;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            
                            if (r < 50 && g < 50 && b < 50) {
                                blackPixelCount++;
                            } else if (r > 240 && g > 240 && b > 240) {
                                whitePixelCount++;
                            } else if (Math.abs(r - g) < 20 && Math.abs(g - b) < 20) {
                                grayPixelCount++;
                            } else {
                                colorPixelCount++;
                            }
                        }
                        
                        resolve({
                            blackPixelCount,
                            whitePixelCount,
                            grayPixelCount,
                            colorPixelCount,
                            totalPixels: canvas.width * canvas.height,
                            dimensions: `${canvas.width}x${canvas.height}`
                        });
                    };
                    img.src = URL.createObjectURL(imageBlob);
                });
            }
            
            async extractTextFromPDF(pdfFile) {
                // This would use PDF.js to extract text directly from PDF
                return 'Text extraction not implemented in test - would extract actual PDF text here';
            }
            
            async checkTextPreservation(imageBlob, originalText) {
                // Simple check: if we have content pixels, assume text is preserved
                const analysis = await this.analyzeComplexContent(imageBlob);
                return analysis.contentRatio > 0.05; // 5% content threshold
            }
            
            addCanvasToResults(title, canvas) {
                const container = document.createElement('div');
                container.className = 'canvas-container';
                container.innerHTML = `<h4>${title}</h4>`;
                
                const clonedCanvas = document.createElement('canvas');
                clonedCanvas.width = canvas.width;
                clonedCanvas.height = canvas.height;
                const clonedCtx = clonedCanvas.getContext('2d');
                clonedCtx.drawImage(canvas, 0, 0);
                
                container.appendChild(clonedCanvas);
                document.getElementById('test-results').appendChild(container);
            }
            
            showFinalResults() {
                const passedTests = this.results.filter(r => r.passed).length;
                const totalTests = this.results.length;
                const allPassed = passedTests === totalTests;
                
                const summary = document.createElement('div');
                summary.className = `test-result ${allPassed ? 'test-pass' : 'test-fail'}`;
                summary.innerHTML = `
                    <h2>${allPassed ? 'üéâ ALL TESTS PASSED!' : '‚ùå SOME TESTS FAILED'}</h2>
                    <p>Passed: ${passedTests}/${totalTests} tests</p>
                    ${allPassed ? 
                        '<p><strong>‚úÖ PDF CONTENT PRESERVATION IS WORKING!</strong></p>' : 
                        '<p><strong>‚ùå PDF content preservation needs more work.</strong></p>'
                    }
                `;
                
                document.getElementById('test-results').appendChild(summary);
                
                this.log(`<h2>Final Result: ${passedTests}/${totalTests} tests passed</h2>`);
            }
        }
        
        let testRunner;
        
        function runAllTests() {
            testRunner = new ContentPreservationTests();
            testRunner.runAllTests();
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
    </script>
</body>
</html>